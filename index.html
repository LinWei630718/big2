<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>BIG2 å¤§è€äºŒ å¤šäººç«¶æŠ€ç‰ˆ</title>
<style>
/* è«‹åœ¨æ­¤è™•å®Œæ•´è²¼ä¸Šæ‚¨åŸå§‹æª”æ¡ˆä¸­çš„ <style> å…§å®¹ */
/* ä¸¦åœ¨æœ€ä¸‹æ–¹åŠ å…¥å¤§å»³çš„ CSS */
.lobby-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, #0f5132, #063d25); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 200; }
.lobby-box { background: rgba(0, 0, 0, 0.6); border: 2px solid #ffc300; border-radius: 15px; padding: 30px; width: 85%; max-width: 400px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
.lobby-input { width: 80%; padding: 12px; margin: 15px 0; font-size: 20px; text-align: center; border-radius: 8px; border: none; outline: none; font-weight: bold; }
.btn-join { background: #ffc300; color: #333; width: 85%; padding: 12px; font-size: 18px; margin-top: 10px; }
.waiting-text { color: #4ade80; margin-top: 15px; font-size: 16px; display: none; }
</style>
</head>
<body>

<div id="lobby" class="lobby-overlay">
    <div class="lobby-box">
        <h2 style="color: #ffc300;">ğŸ‚¡ BIG2 å¤šäººç«¶æŠ€ç‰ˆ</h2>
        <p style="color: #ddd; font-size: 14px;">è¼¸å…¥ç›¸åŒæ•¸å­—é€²å…¥åŒä¸€å€‹æˆ¿é–“</p>
        <input type="number" id="roomNumber" class="lobby-input" placeholder="ä¾‹å¦‚: 888">
        <button class="btn-join" onclick="joinRoom()">é€²å…¥æˆ¿é–“</button>
        <div id="waitingText" class="waiting-text">ç­‰å¾…å…¶ä»–ç©å®¶... (1/4)</div>
        <button id="btnStartGame" class="btn-play" style="display:none; margin-top:15px; width:85%;" onclick="requestStartGame()">åŠ å…¥ AI é–‹å§‹</button>
    </div>
</div>

<div class="top-panel" id="scoreboard"><div class="scoreboard-title">ğŸ† å¤šäººæˆ¿é–“æˆ°æ³</div></div>
<div id="info">è«‹å…ˆåŠ å…¥æˆ¿é–“...</div>
<div id="opponentsHUD" class="opponents-hud"></div>
<h3>æ¡Œé¢å€</h3><div id="table"></div>
<h3>ä½ çš„æ‰‹ç‰Œ</h3><div id="player" class="hand"></div>
<div class="controls">
    <button class="btn-play" onclick="play()">å‡ºç‰Œ</button>
    <button class="btn-pass" onclick="pass()">Pass</button>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
// âš ï¸ éƒ¨ç½²æ™‚ï¼Œè«‹å°‡ä¸‹æ–¹çš„ localhost æ›¿æ›ç‚ºæ‚¨çš„ Render ç¶²å€
const socket = io('https://big2-server-hwws.onrender.com:3000'); 

let myPlayerId = localStorage.getItem('big2_playerId');
if (!myPlayerId) { myPlayerId = 'player_' + Math.random().toString(36).substr(2, 9); localStorage.setItem('big2_playerId', myPlayerId); }

let myPlayerIndex = -1, current = -1;
let opponentsCardCounts = [13, 13, 13, 13];
let players = [[]], selected = [];

// éŸ³æ•ˆèˆ‡æ¸²æŸ“å‡½æ•¸ (è«‹ä¿ç•™æ‚¨åŸå§‹çš„ buildCardHTML, renderTable, renderPlayer, toggle é‚è¼¯)
function updateInfo(msg){ document.getElementById("info").innerText = msg; }

function joinRoom() {
    const room = document.getElementById("roomNumber").value;
    if (!room) { alert("è«‹è¼¸å…¥æˆ¿è™Ÿï¼"); return; }
    socket.emit('join_room', { roomNum: room, playerId: myPlayerId });
    document.querySelector('.btn-join').style.display = 'none';
    document.getElementById('waitingText').style.display = 'block';
}

function requestStartGame() {
    socket.emit('force_start', document.getElementById("roomNumber").value);
}

socket.on('room_update', (data) => {
    document.getElementById('waitingText').innerText = `ç­‰å¾…å…¶ä»–ç©å®¶... (${data.playerCount}/4)`;
    if (data.isHost) document.getElementById('btnStartGame').style.display = 'inline-block';
});

socket.on('game_start', (data) => {
    document.getElementById('lobby').style.display = 'none';
    myPlayerIndex = data.yourIndex; players[0] = data.hand; current = data.currentTurn;
    opponentsCardCounts = data.opponentsCount;
    updateInfo(`éŠæˆ²é–‹å§‹ï¼ç”± ç©å®¶ ${current} å…ˆå‡ºç‰Œ`);
    renderPlayer(); renderOpponentsMultiplayer();
});

socket.on('player_action', (data) => {
    const { playerIndex, action, cards, opponentsCount, nextTurn } = data;
    if (action === 'play') {
        renderTable(cards); opponentsCardCounts = opponentsCount;
        if (playerIndex === myPlayerIndex) {
            selected = [];
            players[0] = players[0].filter(c => !cards.some(played => played.rank === c.rank && played.suit === c.suit));
            renderPlayer();
        }
        updateInfo(`ç©å®¶ ${playerIndex} å‡ºäº†ç‰Œ`);
    } else {
        updateInfo(`ç©å®¶ ${playerIndex} é¸æ“‡ Pass`);
    }
    current = nextTurn; renderOpponentsMultiplayer();
});

socket.on('reconnect_sync', (data) => {
    document.getElementById('lobby').style.display = 'none';
    myPlayerIndex = data.yourIndex; players[0] = data.hand; current = data.currentTurn;
    opponentsCardCounts = data.opponentsCount;
    renderPlayer(); renderOpponentsMultiplayer();
    if (data.lastPlay) renderTable(data.lastPlay.cards);
    updateInfo(`âœ… é‡é€£æˆåŠŸï¼`);
});

function renderOpponentsMultiplayer() {
    let hud = document.getElementById("opponentsHUD"); let html = "";
    for (let i = 0; i < 4; i++) {
        if (i === myPlayerIndex) continue;
        let count = opponentsCardCounts[i]; let isActive = (current === i) ? "active" : "";
        html += `<div class="opp-box ${isActive}"><div class="opp-name">ç©å®¶ ${i}</div><div class="opp-count">ğŸ‚  ${count}</div></div>`;
    }
    hud.innerHTML = html;
}

function play() {
    if (current !== myPlayerIndex) return updateInfo("âš ï¸ é‚„æ²’è¼ªåˆ°ä½ å‡ºç‰Œï¼");
    if (selected.length === 0) return updateInfo("âš ï¸ è«‹å…ˆé¸æ“‡ç‰Œï¼");
    socket.emit('play_cards', { room: document.getElementById("roomNumber").value, cards: selected.map(i => players[0][i]) });
}

function pass() {
    if (current !== myPlayerIndex) return updateInfo("âš ï¸ é‚„æ²’è¼ªåˆ°ä½ ï¼");
    selected = []; renderPlayer();
    socket.emit('pass_turn', { room: document.getElementById("roomNumber").value });
}
</script>
</body>
</html>